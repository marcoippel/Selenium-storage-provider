using System;
using System.Configuration;
using System.IO;
using Microsoft.Expression.Encoder.ScreenCapture;
using SeleniumStorageProvider.Enum;
using SeleniumStorageProvider.Interfaces;
using SeleniumStorageProvider.Provider.AzureBlob;

namespace SeleniumStorageProvider
{
    public class ScreenCaptureStorage
    {
        private readonly IStorageProvider _storageProvider;
        private ScreenCaptureJob ScreenCaptureJob { get; set; }
        private string OutputScreenCaptureFile { get; set; }

        /// <summary>
        /// Initializes a new instance of the <see cref="ScreenCaptureStorage"/> class.
        /// </summary>
        public ScreenCaptureStorage(string screenCaptureFolder)
            : this(new AzureBlobProvider(ConfigurationManager.AppSettings["AzureBlob:StorageConnectionString"]), screenCaptureFolder)
        {
            ScreenCaptureJob = new ScreenCaptureJob();
        }

        /// <summary>
        /// Initializes a new instance of the <see cref="ScreenCaptureStorage"/> class.
        /// </summary>
        /// <param name="storage">The storage.</param>
        /// <param name="screenCaptureFileName"></param>
        public ScreenCaptureStorage(IStorageProvider storage, string screenCaptureFileName)
        {
            _storageProvider = storage;
            string destinationDirectory = Path.GetDirectoryName(screenCaptureFileName);
            if (destinationDirectory == null || !Directory.Exists(destinationDirectory))
            {
                throw new DirectoryNotFoundException(string.Format("Directory {0} not found", destinationDirectory));
            }

            if (!screenCaptureFileName.EndsWith(".wmv", StringComparison.OrdinalIgnoreCase))
            {
                throw new FileFormatException("The output file must be an .wmv file");
            }

            OutputScreenCaptureFile = screenCaptureFileName;
            ScreenCaptureJob.OutputScreenCaptureFileName = screenCaptureFileName;
        }

        public void Start()
        {
            ScreenCaptureJob.Start();
        }

        public void Stop()
        {
            ScreenCaptureJob.Stop();
        }

        /// <summary>
        /// Saves the specified page source.
        /// </summary>
        /// <param name="pageSource">The page source.</param>
        /// <param name="url">The URL.</param>
        /// <param name="message">The message.</param>
        /// <param name="methodName">Name of the method.</param>
        /// <param name="type">The type.</param>
        public void Save(string pageSource, string url, string message, string methodName, EventType type)
        {
            this.Stop();
            _storageProvider.Save(OutputScreenCaptureFile, pageSource, url, message, methodName, type);
        }
    }
}
